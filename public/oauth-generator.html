<!DOCTYPE html>
<html>
<head>
    <title>Zoho OAuth Token Generator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; word-break: break-all; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; }
        .info { background: #e7f3ff; border-color: #b3d9ff; }
    </style>
</head>
<body>
    <h1>Zoho OAuth Token Generator</h1>
    
    <div class="step info">
        <h3>ℹ️ Current Configuration</h3>
        <p><strong>Client ID:</strong> <input type="text" id="clientIdInput" placeholder="Enter your Client ID here..." style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; font-family: monospace;" value="1000.9OCSG40I22VHXOS1LHTS6WJU25HYHC"></p>
        <p><strong>Client Secret:</strong> <input type="password" id="clientSecretInput" placeholder="Enter your Client Secret here..." style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; font-family: monospace;"></p>
        <p><strong>Data Center:</strong> <select id="dataCenterSelect" style="padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px;">
            <option value="com">com (US)</option>
            <option value="eu">eu (Europe)</option>
            <option value="in">in (India)</option>
            <option value="au">au (Australia)</option>
            <option value="ca">ca (Canada)</option>
        </select></p>
        <p><strong>Redirect URI:</strong> <span id="redirectUri">Loading...</span></p>
        <p><strong>Scope:</strong> <input type="text" id="scopeInput" placeholder="Enter scope..." style="width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 3px; font-family: monospace;" value="ZohoAnalytics.fullaccess.all"></p>
    </div>

    <div class="step">
        <h3>Step 1: Generate Authorization URL</h3>
        <p>Click the button below to generate the authorization URL:</p>
        <button onclick="generateAuthUrl()">Generate Authorization URL</button>
        <div id="authUrlResult" style="display: none;">
            <p><strong>Authorization URL:</strong></p>
            <div class="code" id="authUrl"></div>
            <p><a id="authUrlLink" href="#" target="_blank">Click here to authorize</a></p>
        </div>
    </div>

    <div class="step">
        <h3>Step 2: Exchange Authorization Code</h3>
        <p>After authorization, paste the authorization code here:</p>
        <input type="text" id="authCode" placeholder="Paste authorization code here...">
        <button onclick="exchangeCode()">Exchange for Refresh Token</button>
        <div id="exchangeResult" style="display: none;">
            <p><strong>Result:</strong></p>
            <div class="code" id="exchangeOutput"></div>
        </div>
    </div>

    <div class="step">
        <h3>Step 3: Update Environment Variables</h3>
        <p>Once you have the new refresh token:</p>
        <ol>
            <li>Go to your Vercel project settings</li>
            <li>Navigate to Environment Variables</li>
            <li>Update <code>ZOHO_REFRESH_TOKEN</code> with the new token</li>
            <li>Redeploy your application</li>
        </ol>
    </div>

    <script>
        // Set redirect URI on page load
        document.getElementById('redirectUri').textContent = window.location.origin + '/oauth-callback.html';

        function generateAuthUrl() {
            const clientId = document.getElementById('clientIdInput').value;
            const dc = document.getElementById('dataCenterSelect').value;
            const redirectUri = window.location.origin + '/oauth-callback.html';
            const scope = document.getElementById('scopeInput').value;
            
            if (!clientId || clientId.trim() === '') {
                alert('Please enter a Client ID');
                return;
            }
            
            if (!scope || scope.trim() === '') {
                alert('Please enter a scope');
                return;
            }
            
            const authUrl = `https://accounts.zoho.${dc}/oauth/v2/auth?` + 
                `client_id=${encodeURIComponent(clientId)}&` +
                `scope=${encodeURIComponent(scope)}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=code&` +
                `access_type=offline&` +
                `prompt=consent&` +
                `state=${encodeURIComponent(Date.now().toString())}`;

            document.getElementById('authUrl').textContent = authUrl;
            document.getElementById('authUrlLink').href = authUrl;
            document.getElementById('authUrlResult').style.display = 'block';
        }

        async function exchangeCode() {
            const authCode = document.getElementById('authCode').value.trim();
            const clientId = document.getElementById('clientIdInput').value;
            const clientSecret = document.getElementById('clientSecretInput').value;
            const dc = document.getElementById('dataCenterSelect').value;
            
            if (!authCode) {
                alert('Please enter the authorization code');
                return;
            }
            
            if (!clientId || clientId.trim() === '') {
                alert('Please enter a Client ID');
                return;
            }
            
            if (!clientSecret || clientSecret.trim() === '') {
                alert('Please enter a Client Secret');
                return;
            }

            const redirectUri = window.location.origin + '/oauth-callback.html';
            
            try {
                const response = await fetch('/api/zoho-analytics.mjs?exchangeCode=1', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: authCode,
                        redirect_uri: redirectUri,
                        client_id: clientId,
                        client_secret: clientSecret,
                        data_center: dc
                    })
                });

                const result = await response.json();
                
                document.getElementById('exchangeOutput').textContent = JSON.stringify(result, null, 2);
                document.getElementById('exchangeResult').style.display = 'block';
                
                if (result.success) {
                    // Extract tokens from the response
                    const refreshToken = result.refreshToken || result.data?.refresh_token || 'NOT PROVIDED';
                    const accessToken = result.accessToken || result.data?.access_token || 'NOT PROVIDED';
                    
                    document.getElementById('exchangeResult').className = 'step success';
                    document.getElementById('exchangeOutput').innerHTML = 
                        '<strong>✅ Success!</strong><br>' +
                        '<strong>Full Response:</strong><br>' +
                        '<pre>' + JSON.stringify(result, null, 2) + '</pre><br>' +
                        '<strong>Refresh Token:</strong> ' + refreshToken + '<br>' +
                        '<strong>Access Token:</strong> ' + accessToken + '<br>' +
                        '<br><strong>Copy this refresh token to your Vercel environment variables:</strong><br>' +
                        '<code>' + refreshToken + '</code>';
                } else {
                    document.getElementById('exchangeResult').className = 'step error';
                }
            } catch (error) {
                document.getElementById('exchangeOutput').textContent = 'Error: ' + error.message;
                document.getElementById('exchangeResult').style.display = 'block';
                document.getElementById('exchangeResult').className = 'step error';
            }
        }
    </script>
</body>
</html>
